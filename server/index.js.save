require('dotenv').config();
const express = require('express');
const mongoose = require('mongoose');
const stripe = require('stripe')(process.env.STRIPE_SECRET_KEY);
const bodyParser = require('body-parser');
const cors = require('cors');

const app = express();
app.use(cors());
app.use(express.json());

// --- Connect to MongoDB ---
mongoose.connect(process.env.MONGO_URI, {
  useNewUrlParser: true,
  useUnifiedTopology: true,
})
.then(()=>console.log('MongoDB connected'))
.catch(err=>console.error('Mongo connect error:', err.message));

// --- MongoDB Models ---
const UserSchema = new mongoose.Schema({
  email: { type: String, required: true, unique: true },
  name: String,
});
const User = mongoose.model('User', UserSchema);

const BattleSchema = new mongoose.Schema({
  title: String,
  sport: String, // 'car' (for now)
  entryFeeUSD: Number, // dollars
  startAt: Date,
  state: { type: String, default: 'open' }, // open/ongoing/finished
});
const Battle = mongoose.model('Battle', BattleSchema);

const EntrySchema = new mongoose.Schema({
  user: { type: mongoose.Schema.Types.ObjectId, ref: 'User' },
  battle: { type: mongoose.Schema.Types.ObjectId, ref: 'Battle' },
  stripeSessionId: String,
  paid: { type: Boolean, default: false },
  locked: { type: Boolean, default: false }, // locked when matched
  createdAt: { type: Date, default: Date.now },
});
const Entry = mongoose.model('Entry', EntrySchema);

// --- Routes ---
app.get('/', (req,res)=>res.json({ ok:true, app:'BattleHub Backend' }));

// Admin create battle
app.post('/admin/battles', async (req,res)=>{
  try {
    const { title, sport='car', entryFeeUSD=5, startAt } = req.body;
    const b = new Battle({ title, sport, entryFeeUSD, startAt });
    await b.save();
    res.json(b);
  } catch(err){
    res.status(500).json({ error: err.message });
  }
});

// List battles
app.get('/battles', async (req,res)=>{
  const list = await Battle.find().sort({ startAt:1 });
  res.json(list);
});

// Create or find user
app.post('/users', async (req,res)=>{
  try {
    const { email, name } = req.body;
    let user = await User.findOne({ email });
    if(!user) user = await User.create({ email, name });
    res.json(user);
  } catch(err){
    res.status(500).json({ error: err.message });
  }
});

// Join battle / Stripe Checkout
app.post('/battles/:id/join', async (req,res)=>{
  try {
    const battleId = req.params.id;
    const { email, name } = req.body;
    const battle = await Battle.findById(battleId);
    if(!battle) return res.status(404).json({ error:'Battle not found' });

    let user = await User.findOne({ email });
    if(!user) user = await User.create({ email, name });

    const amountCents = Math.round((battle.entryFeeUSD || 1)*100);

    const session = await stripe.checkout.sessions.create({
      payment_method_types: ['card'],
      mode: 'payment',
      line_items:[{
        price_data:{
          currency:'usd',
          product_data:{ name:`Entry: ${battle.title}` },
          unit_amount: amountCents,
        },
        quantity:1,
      }],
      metadata:{
        battleId:battle._id.toString(),
        userId:user._id.toString(),
      },
      success_url: `${process.env.BASE_URL}/success?session_id={CHECKOUT_SESSION_ID}`,
      cancel_url: `${process.env.BASE_URL}/cancel`,
    });

    const entry = await Entry.create({
      user: user._id,
      battle: battle._id,
      stripeSessionId: session.id,
      paid: false,
    });

    res.json({ url: session.url, sessionId: session.id });
  } catch(err){
    res.status(500).json({ error: err.message });
  }
});

// Stripe webhook for payment verification
app.post('/webhook', bodyParser.raw({ type:'application/json' }), async (req,res)=>{
  const sig = req.headers['stripe-signature'];
  let event;
  try {
    event = stripe.webhooks.constructEvent(req.body, sig, process.env.STRIPE_WEBHOOK_SECRET);
  } catch(err){
    console.error('Webhook signature error:', err.message);
    return res.status(400).send(`Webhook Error: ${err.message}`);
  }

  if(event.type==='checkout.session.completed'){
    const session = event.data.object;
    console.log('checkout.session.completed', session.id);
    await Entry.findOneAndUpdate({ stripeSessionId: session.id }, { paid:true });
  }

  res.json({ received:true });
});

// List entries for a battle
app.get('/battles/:id/entries', async (req,res)=>{
  const entries = await Entry.find({ battle:req.params.id }).populate('user');
  res.json(entries);
});

// Start server
const PORT = process.env.PORT || 4000;
app.listen(PORT, ()=>console.log(`BattleHub server listening on ${PORT}`));

